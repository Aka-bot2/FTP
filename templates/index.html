<!DOCTYPE html>
<html>
<head>
  <title>File Manager</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <h1>Filo</h1>
    <div class="nav-links">
      <a href="{{ url_for('index') }}">Home</a>
      <a href="#upload">Uploads</a>
      <a href="#files">Files</a>
      <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
    </div>
  </div>

  <!-- Main container -->
  <div class="container files-container">
    <h2 id="upload">Upload File</h2>
    <form id="uploadForm" action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
      <input type="file" name="file" required>
      <button type="submit">Upload</button>
    </form>

    <!-- Upload Progress -->
    <div class="progress-container">
      <div id="uploadProgress" class="progress-bar">0%</div>
    </div>

    <h2 id="files">Available Files</h2>
    <ul>
      {% for file in files %}
        <li>
          <span>{{ file }}</span>
          <a href="{{ url_for('download_file', filename=file) }}">
            <button type="button">Download</button>
          </a>
        </li>
      {% endfor %}
    </ul>

    <!-- Download Progress -->
    <div class="progress-container">
      <div id="downloadProgress" class="progress-bar">0%</div>
    </div>
  </div>

  <script>
    // Upload progress (single file upload, no chunking)
    document.getElementById("uploadForm").addEventListener("submit", function (e) {
      e.preventDefault();

      let formData = new FormData(this);
      let xhr = new XMLHttpRequest();

      xhr.open("POST", "{{ url_for('upload_file') }}", true);

      xhr.upload.addEventListener("progress", function (e) {
        if (e.lengthComputable) {
          let percent = Math.round((e.loaded / e.total) * 100);
          let bar = document.getElementById("uploadProgress");
          bar.style.width = percent + "%";
          bar.textContent = percent + "%";
        }
      });

      xhr.onload = function () {
        if (xhr.status === 200) {
          window.location.reload();
        }
      };

      xhr.send(formData);
    });

    // Download progress
    function downloadFile(url) {
      let xhr = new XMLHttpRequest();
      xhr.open("GET", url, true);
      xhr.responseType = "blob";

      xhr.addEventListener("progress", function (e) {
        if (e.lengthComputable) {
          let percent = Math.round((e.loaded / e.total) * 100);
          let bar = document.getElementById("downloadProgress");
          bar.style.width = percent + "%";
          bar.textContent = percent + "%";
        }
      });

      xhr.onload = function () {
        if (xhr.status === 200) {
          let blob = xhr.response;
          let link = document.createElement("a");
          link.href = window.URL.createObjectURL(blob);

          // Try to get filename from headers
          let filename = "downloaded.file";
          let dispo = xhr.getResponseHeader("Content-Disposition");
          if (dispo && dispo.indexOf("filename=") !== -1) {
            filename = dispo.split("filename=")[1].trim();
          }
          link.download = filename;
          link.click();

          // Reset bar
          let bar = document.getElementById("downloadProgress");
          bar.style.width = "0%";
          bar.textContent = "0%";
        }
      };

      xhr.send();
    }
  </script>
</body>
</html>
